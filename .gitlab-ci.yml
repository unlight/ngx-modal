image: ${CI_REGISTRY}/efs/docker/ci-nodechrome:10

stages:
    - test
    - release

test:
    stage: test
    tags: ['docker', 'linux']
    script:
        - node -v
        - npm -v
        - npm i
        - npm test
        - npm run build
    coverage: '/All files\s+\|\s+(\S+)\s+\|/'

release:
    stage: release
    tags: ['docker', 'linux']
    script:
        - npm i
        - npm run build
        - npx semantic-release
    only:
        refs:
            - master

next:
    stage: release
    tags: ['docker', 'linux']
    script:
        - npm i
        - npm run build
        - npm config ls -l
        - npm config set registry "http://nexus.ert.com/nexus/content/repositories/npm-automation"
        - npm config ls -l
        - npx semantic-release --branch next -d
    only:
        refs:
            - next
